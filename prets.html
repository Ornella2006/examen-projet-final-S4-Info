<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des prêts</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button, select { margin: 5px; padding: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .error { color: red; }
    .success { color: green; }
    #simulation-result { margin-top: 10px; }
  </style>
</head>
<body>

  <h1>Gestion des prêts</h1>

  <div>
    <h2>Créer une demande de prêt</h2>
    <select id="idClient" required>
      <option value="">Sélectionner un client</option>
    </select>
    <select id="idTypePret" required>
      <option value="">Sélectionner un type de prêt</option>
    </select>
    <select id="idEtablissementFinancier" required>
      <option value="">Sélectionner un établissement</option>
    </select>
    <input type="number" id="montant" placeholder="Montant (€)" step="0.01" min="0" required>
    <input type="number" id="dureeMois" placeholder="Durée (mois)" min="1" required>
    <input type="number" id="delaiPremierRemboursementMois" placeholder="Délai 1er remboursement (mois)" min="0" max="24" value="0">
    <input type="date" id="dateDemande" required>
    <input type="number" id="tauxAssurance" placeholder="Taux d'assurance (%)" step="0.01" min="0" max="5" value="0">
    <button onclick="creerPret()">Créer</button>
    <button onclick="simulerPret()">Simuler</button>
    <p id="error-pret-message" class="error"></p>
    <p id="success-pret-message" class="success"></p>
    <div id="simulation-result"></div>
  </div>

  <h2>Liste des prêts</h2>
  <table id="table-prets">
    <thead>
      <tr>
        <th>ID Prêt</th>
        <th>Client</th>
        <th>Type de prêt</th>
        <th>Montant (€)</th>
        <th>Durée (mois)</th>
        <th>Délai 1er remboursement (mois)</th>
        <th>Date demande</th>
        <th>Date retour estimée</th>
        <th>Intérêts (€)</th>
        <th>Statut</th>
        <th>Annuité mensuelle (€)</th>
        <th>Solde restant (€)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // const apiBase = "http://localhost/L2/S4/projet_final_S4/examen-projet-final-S4-Info/ws";

    const apiBase = window.location.origin + "/ws";

    
    function ajax(method, url, data, callback, errorCallback) {
      const xhr = new XMLHttpRequest();
      xhr.open(method, apiBase + url, true);
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            callback(JSON.parse(xhr.responseText));
          } else {
            errorCallback(xhr.status, xhr.responseText);
          }
        }
      };
      console.log(`Envoi ${method} ${url} avec données : ${data}`);
      xhr.send(data);
    }

    function chargerClients() {
      ajax("GET", "/clients", null, (data) => {
        const select = document.getElementById("idClient");
        select.innerHTML = '<option value="">Sélectionner un client</option>';
        data.forEach(c => {
          const option = document.createElement("option");
          option.value = c.idClient;
          option.textContent = `${c.nom} ${c.prenom}`;
          select.appendChild(option);
        });
      }, (status, error) => {
        document.getElementById("error-pret-message").textContent = `Erreur de chargement des clients: ${error}`;
      });
    }

    function chargerTypesPret() {
      ajax("GET", "/types-prets", null, (data) => {
        const select = document.getElementById("idTypePret");
        select.innerHTML = '<option value="">Sélectionner un type de prêt</option>';
        data.forEach(t => {
          const option = document.createElement("option");
          option.value = t.idTypePret;
          option.textContent = `${t.libelle} (Taux: ${t.tauxInteret}%, Durée max: ${t.dureeMaxMois} mois)`;
          select.appendChild(option);
        });
      }, (status, error) => {
        document.getElementById("error-pret-message").textContent = `Erreur de chargement des types de prêt: ${error}`;
      });
    }

    function chargerEtablissements() {
      ajax("GET", "/etablissements", null, (data) => {
        const select = document.getElementById("idEtablissementFinancier");
        select.innerHTML = '<option value="">Sélectionner un établissement</option>';
        data.forEach(e => {
          const option = document.createElement("option");
          option.value = e.idEtablissementFinancier;
          option.textContent = `${e.nom} (Fonds: ${e.fondTotal} €)`;
          select.appendChild(option);
        });
      }, (status, error) => {
        document.getElementById("error-pret-message").textContent = `Erreur de chargement des établissements: ${error}`;
      });
    }

    function creerPret() {
      const idClient = document.getElementById("idClient").value;
      const idTypePret = document.getElementById("idTypePret").value;
      const idEtablissementFinancier = document.getElementById("idEtablissementFinancier").value;
      const montant = document.getElementById("montant").value;
      const dureeMois = document.getElementById("dureeMois").value;
      const delaiPremierRemboursementMois = document.getElementById("delaiPremierRemboursementMois").value;
      const dateDemande = document.getElementById("dateDemande").value;
      const tauxAssurance = document.getElementById("tauxAssurance").value;

      if (!idClient || !idTypePret || !idEtablissementFinancier || !montant || !dureeMois || !dateDemande) {
        document.getElementById("error-pret-message").textContent = "Tous les champs obligatoires doivent être remplis.";
        return;
      }

      const parsedMontant = parseFloat(montant);
      const parsedDureeMois = parseInt(dureeMois);
      const parsedDelai = parseInt(delaiPremierRemboursementMois) || 0;
      const parsedTauxAssurance = parseFloat(tauxAssurance) || 0;

      if (isNaN(parsedMontant) || parsedMontant <= 0) {
        document.getElementById("error-pret-message").textContent = "Le montant doit être un nombre positif.";
        return;
      }
      if (isNaN(parsedDureeMois) || parsedDureeMois <= 0) {
        document.getElementById("error-pret-message").textContent = "La durée doit être un nombre positif.";
        return;
      }
      if (parsedDelai < 0 || parsedDelai > 24) {
        document.getElementById("error-pret-message").textContent = "Le délai de premier remboursement doit être compris entre 0 et 24 mois.";
        return;
      }
      if (parsedTauxAssurance < 0 || parsedTauxAssurance > 5) {
        document.getElementById("error-pret-message").textContent = "Le taux d'assurance doit être compris entre 0 et 5%.";
        return;
      }

      const data = `idClient=${idClient}&idTypePret=${idTypePret}&idEtablissementFinancier=${idEtablissementFinancier}&montant=${parsedMontant}&dureeMois=${parsedDureeMois}&delaiPremierRemboursementMois=${parsedDelai}&dateDemande=${dateDemande}&tauxAssurance=${parsedTauxAssurance}`;
      console.log("Valeurs avant envoi:", { idClient, idTypePret, idEtablissementFinancier, montant: parsedMontant, dureeMois: parsedDureeMois, delaiPremierRemboursementMois: parsedDelai, dateDemande, tauxAssurance: parsedTauxAssurance });

      ajax("POST", "/prets", data, (response) => {
        document.getElementById("success-pret-message").textContent = `Prêt créé avec l'ID ${response.id}.`;
        chargerPrets();
        document.getElementById("idClient").value = "";
        document.getElementById("idTypePret").value = "";
        document.getElementById("idEtablissementFinancier").value = "";
        document.getElementById("montant").value = "";
        document.getElementById("dureeMois").value = "";
        document.getElementById("delaiPremierRemboursementMois").value = "0";
        document.getElementById("dateDemande").value = "";
        document.getElementById("tauxAssurance").value = "0";
        document.getElementById("error-pret-message").textContent = "";
        document.getElementById("simulation-result").innerHTML = "";
      }, (status, error) => {
        document.getElementById("error-pret-message").textContent = `Erreur lors de la création du prêt: ${error}`;
      });
    }

    function simulerPret() {
      const idTypePret = document.getElementById("idTypePret").value;
      const montant = document.getElementById("montant").value;
      const dureeMois = document.getElementById("dureeMois").value;
      const delaiPremierRemboursementMois = document.getElementById("delaiPremierRemboursementMois").value;
      const dateDemande = document.getElementById("dateDemande").value;
      const tauxAssurance = document.getElementById("tauxAssurance").value;

      if (!idTypePret || !montant || !dureeMois || !dateDemande) {
        document.getElementById("error-pret-message").textContent = "Veuillez remplir tous les champs pour la simulation.";
        return;
      }

      const parsedMontant = parseFloat(montant);
      const parsedDureeMois = parseInt(dureeMois);
      const parsedDelai = parseInt(delaiPremierRemboursementMois) || 0;
      const parsedTauxAssurance = parseFloat(tauxAssurance) || 0;

      const data = `idTypePret=${idTypePret}&montant=${parsedMontant}&dureeMois=${parsedDureeMois}&delaiPremierRemboursementMois=${parsedDelai}&dateDemande=${dateDemande}&tauxAssurance=${parsedTauxAssurance}`;
      ajax("POST", "/prets/simuler", data, (result) => {
        document.getElementById("simulation-result").innerHTML = `
          <p><strong>Résultat de la simulation :</strong></p>
          <p>Annuité mensuelle : ${result.annuite} €</p>
          <p>Intérêts totaux : ${result.interetsTotaux} €</p>
          <p>Coût total : ${result.coutTotal} €</p>
          <p>Date de retour estimée : ${result.dateRetourEstimee}</p>
        `;
        document.getElementById("error-pret-message").textContent = "";
      }, (status, error) => {
        document.getElementById("error-pret-message").textContent = `Erreur lors de la simulation: ${error}`;
      });
    }

    function chargerPrets() {
      ajax("GET", "/prets", null, (data) => {
        const tbody = document.querySelector("#table-prets tbody");
        tbody.innerHTML = "";
        data.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.idPret}</td>
            <td>${p.nom} ${p.prenom}</td>
            <td>${p.libelle}</td>
            <td>${p.montant}</td>
            <td>${p.dureeMois}</td>
            <td>${p.delaiPremierRemboursementMois}</td>
            <td>${p.dateDemande}</td>
            <td>${p.dateRetourEstimee}</td>
            <td>${p.interets}</td>
            <td>${p.statut}</td>
            <td>${p.annuiteMensuelle}</td>
            <td>${p.soldeRestant}</td>
            <td>${p.statut === 'en_attente' ? `<button onclick="validerPret(${p.idPret})">Valider</button>` : ''}</td>
          `;
          tbody.appendChild(tr);
        });
      }, (status, error) => {
        document.getElementById("error-pret-message").textContent = `Erreur de chargement des prêts: ${error}`;
      });
    }

    function validerPret(idPret) {
      ajax("POST", `/prets/${idPret}/valider`, "", (response) => {
        document.getElementById("success-pret-message").textContent = `Prêt ${idPret} validé.`;
        chargerPrets();
      }, (status, error) => {
        document.getElementById("error-pret-message").textContent = `Erreur lors de la validation du prêt: ${error}`;
      });
    }

    chargerClients();
    chargerTypesPret();
    chargerEtablissements();
    chargerPrets();

    document.getElementById("dateDemande").value = new Date().toISOString().split('T')[0];
  </script>

</body>
</html>