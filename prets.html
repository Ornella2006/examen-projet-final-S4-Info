<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Gestion des prêts clients</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button, select { margin: 5px; padding: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>

  <h1>Gestion des prêts clients</h1>

  <div>
    <h2>Nouveau prêt</h2>
    <select id="idClient" required>
      <option value="">Sélectionner un client</option>
    </select>
    <select id="idTypePret" required>
      <option value="">Sélectionner un type de prêt</option>
    </select>
    <select id="idEtablissementFinancier" required>
      <option value="">Sélectionner un établissement</option>
    </select>
    <input type="number" id="montant" placeholder="Montant (€)" step="100" min="1000" required>
    <input type="number" id="dureeMois" placeholder="Durée (mois)" min="1" required>
    <input type="date" id="dateDemande" required>
    <button onclick="creerPret()">Créer le prêt</button>
    <p id="error-message" class="error"></p>
    <p id="success-message" class="success"></p>
  </div>

  <h2>Prêts enregistrés</h2>
  <table id="table-prets">
    <thead id="table-prets-thead">
      <tr>
        <th>ID</th>
        <th>Client</th>
        <th>Type de prêt</th>
        <th>Montant (€)</th>
        <th>Durée (mois)</th>
        <th>Intérêts (€)</th>
        <th>Date de demande</th>
        <th>Date de retour estimée</th>
        <th>Statut</th>
        <th class="actions-column">Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const apiBase = "http://localhost/examen-projet-final-S4-Info/ws";

    function ajax(method, url, data, callback, errorCallback) {
      const xhr = new XMLHttpRequest();
      xhr.open(method, apiBase + url, true);
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            callback(JSON.parse(xhr.responseText));
          } else {
            errorCallback(xhr.status, xhr.responseText);
          }
        }
      };
      console.log(`Envoi ${method} ${url} avec données : ${data}`);
      xhr.send(data);
    }

    function chargerClients() {
      ajax("GET", "/clients", null, (data) => {
        const select = document.getElementById("idClient");
        select.innerHTML = '<option value="">Sélectionner un client</option>';
        data.forEach(c => {
          const option = document.createElement("option");
          option.value = c.idClient;
          option.textContent = `${c.nom} ${c.prenom} (${c.email})`;
          select.appendChild(option);
        });
      }, (status, error) => {
        document.getElementById("error-message").textContent = `Erreur de chargement des clients: ${error}`;
      });
    }

    function chargerTypesPrets() {
      ajax("GET", "/types-prets", null, (data) => {
        const select = document.getElementById("idTypePret");
        select.innerHTML = '<option value="">Sélectionner un type de prêt</option>';
        data.forEach(t => {
          const option = document.createElement("option");
          option.value = t.idTypePret;
          option.textContent = `${t.libelle} (Taux: ${t.tauxInteret}%, Durée max: ${t.dureeMaxMois} mois)`;
          select.appendChild(option);
        });
      }, (status, error) => {
        document.getElementById("error-message").textContent = `Erreur de chargement des types de prêts: ${error}`;
      });
    }

    function chargerEtablissements() {
      ajax("GET", "/etablissements", null, (data) => {
        const select = document.getElementById("idEtablissementFinancier");
        select.innerHTML = '<option value="">Sélectionner un établissement</option>';
        data.forEach(e => {
          const option = document.createElement("option");
          option.value = e.idEtablissementFinancier;
          option.textContent = `${e.nomEtablissementFinancier} (Solde: ${e.fondTotal} €)`;
          select.appendChild(option);
        });
      }, (status, error) => {
        document.getElementById("error-message").textContent = `Erreur de chargement des établissements: ${error}`;
      });
    }

    function creerPret() {
      const idClient = document.getElementById("idClient").value;
      const idTypePret = document.getElementById("idTypePret").value;
      const idEtablissementFinancier = document.getElementById("idEtablissementFinancier").value;
      const montant = document.getElementById("montant").value;
      const dureeMois = document.getElementById("dureeMois").value;
      const dateDemande = document.getElementById("dateDemande").value;

      if (!idClient) {
        document.getElementById("error-message").textContent = "Sélectionnez un client.";
        return;
      }
      if (!idTypePret) {
        document.getElementById("error-message").textContent = "Sélectionnez un type de prêt.";
        return;
      }
      if (!idEtablissementFinancier) {
        document.getElementById("error-message").textContent = "Sélectionnez un établissement.";
        return;
      }
      const parsedMontant = parseFloat(montant);
      if (montant === "" || isNaN(parsedMontant) || parsedMontant < 1000) {
        document.getElementById("error-message").textContent = "Le montant doit être supérieur ou égal à 1000 €.";
        return;
      }
      const parsedDureeMois = parseInt(dureeMois);
      if (dureeMois === "" || isNaN(parsedDureeMois) || parsedDureeMois <= 0) {
        document.getElementById("error-message").textContent = "La durée doit être un entier positif.";
        return;
      }
      if (!dateDemande) {
        document.getElementById("error-message").textContent = "La date de demande est requise.";
        return;
      }

      const data = `idClient=${idClient}&idTypePret=${idTypePret}&idEtablissementFinancier=${idEtablissementFinancier}&montant=${parsedMontant}&dureeMois=${parsedDureeMois}&dateDemande=${dateDemande}`;
      console.log("Valeurs avant envoi:", { idClient, idTypePret, idEtablissementFinancier, montant: parsedMontant, dureeMois: parsedDureeMois, dateDemande });

      ajax("POST", "/prets", data, (response) => {
        document.getElementById("success-message").textContent = `Prêt créé avec l'ID ${response.id}. Cliquez sur Valider pour confirmer.`;
        chargerPrets();
        document.getElementById("error-message").textContent = "";
      }, (status, error) => {
        document.getElementById("error-message").textContent = `Erreur lors de la création: ${error}`;
      });
    }

    function validerPret(id) {
      ajax("PUT", `/prets/${id}/valider`, null, () => {
        document.getElementById("success-message").textContent = "Prêt validé avec succès.";
        chargerPrets();
        document.getElementById("error-message").textContent = "";
      }, (status, error) => {
        document.getElementById("error-message").textContent = `Erreur lors de la validation: ${error}`;
      });
    }

    function chargerPrets() {
      ajax("GET", "/prets", null, (data) => {
        const tbody = document.querySelector("#table-prets tbody");
        const thead = document.querySelector("#table-prets-thead");
        tbody.innerHTML = "";

        // Vérifier si au moins un prêt est en attente
        const hasPendingLoans = data.some(p => p.statut === 'en_attente');

        // Définir l'en-tête du tableau
        thead.innerHTML = `
          <tr>
            <th>ID</th>
            <th>Client</th>
            <th>Type de prêt</th>
            <th>Montant (€)</th>
            <th>Durée (mois)</th>
            <th>Intérêts (€)</th>
            <th>Date de demande</th>
            <th>Date de retour estimée</th>
            <th>Statut</th>
            ${hasPendingLoans ? '<th class="actions-column">Actions</th>' : ''}
          </tr>
        `;

        // Remplir le corps du tableau
        data.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.idPret}</td>
            <td>${p.nom} ${p.prenom}</td>
            <td>${p.libelle}</td>
            <td>${p.montant}</td>
            <td>${p.dureeMois}</td>
            <td>${p.interets}</td>
            <td>${p.dateDemande}</td>
            <td>${p.dateRetourEstimee}</td>
            <td>${p.statut}</td>
            ${hasPendingLoans && p.statut === 'en_attente' ? '<td><button onclick="validerPret(' + p.idPret + ')">Valider</button></td>' : (hasPendingLoans ? '<td></td>' : '')}
          `;
          tbody.appendChild(tr);
        });
      }, (status, error) => {
        document.getElementById("error-message").textContent = `Erreur de chargement des prêts: ${error}`;
      });
    }

    function resetForm() {
      document.getElementById("idClient").value = "";
      document.getElementById("idTypePret").value = "";
      document.getElementById("idEtablissementFinancier").value = "";
      document.getElementById("montant").value = "";
      document.getElementById("dureeMois").value = "";
      document.getElementById("dateDemande").value = "";
      document.getElementById("error-message").textContent = "";
      document.getElementById("success-message").textContent = "";
    }

    // Charger les données au démarrage
    chargerClients();
    chargerTypesPrets();
    chargerEtablissements();
    chargerPrets();
  </script>

</body>
</html>